apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
kind: TalosControlPlane
metadata:
  name: controlplane
spec:
  version: v1.34.1
  replicas: 1
  rolloutStrategy:
    type: OnDelete
  infrastructureTemplate:
    kind: ProxmoxMachineTemplate
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
    name: controlplane
    namespace: homelab
  controlPlaneConfig:
    controlplane:
      generateType: controlplane
      strategicPatches:
        - |
          - op: add
            path: /machine/install
            value:
              disk: /dev/sda
              image: factory.talos.dev/nocloud-installer/aaafc937bd215b9f17980fe8ff2ea197f835e06c57aa46a01d3dc2e6e8f494d8:v1.11.1
              extraKernelArgs:
                - net.ifnames=0
          - op: add
            path: /machine/network
            value:
              hostname: controlplane
              nameservers:
                - 8.8.8.8
                - 8.8.4.4
              interfaces:
                - interface: eth0
                  dhcp: false
                  addresses:
                    - 10.0.0.12/24
                  routes:
                    - network: 0.0.0.0/0
                      gateway: 10.0.0.1
          - op: add
            path: /machine/kubelet
            value:
              image: ghcr.io/siderolabs/kubelet:v1.34.1
              nodeIP:
                validSubnets:
                  - 10.0.0.12/32
              extraConfig:
                registerNode: true
              extraArgs:
                rotate-server-certificates: true
          - op: add
            path: /cluster/network
            value:
              cni:
                name: none
          - op: add
            path: /cluster
            value:
              apiServer:
                image: registry.k8s.io/kube-apiserver:v1.34.1
                disablePodSecurityPolicy: true
                admissionControl: []
              controllerManager:
                image: registry.k8s.io/kube-controller-manager:v1.34.1
                extraArgs:
                  bind-address: "0.0.0.0"
                  secure-port: "10257"
              scheduler:
                image: registry.k8s.io/kube-scheduler:v1.34.1
                extraArgs:
                  bind-address: "0.0.0.0"
                  secure-port: "10259"
              proxy:
                image: registry.k8s.io/kube-proxy:v1.34.1
                extraArgs:
                  metrics-bind-address: "0.0.0.0:10249"
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
kind: ProxmoxMachineTemplate
metadata:
  name: controlplane
spec:
  template:
    spec:
      disks:
        bootVolume:
          disk: scsi0
          sizeGb: 20
      format: qcow2
      full: true
      memoryMiB: 8192
      network:
        default:
          bridge: vmbr0
          model: virtio
      numCores: 4
      numSockets: 1
      sourceNode: proxmox
      templateID: 102
      checks:
        skipCloudInitStatus: true